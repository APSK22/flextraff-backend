name: 🧪 Comprehensive Tests (Manual/Scheduled)

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of tests to run'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - integration
        - performance
        - slow
        - database

  # Scheduled run (every Sunday at 2 AM UTC)
  schedule:
    - cron: '0 2 * * 0'

env:
  PYTHON_VERSION: "3.11"

jobs:
  comprehensive-tests:
    name: 🧪 Comprehensive Test Suite
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout Code
      uses: actions/checkout@v4

    - name: 🐍 Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: 📦 Cache Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: 🔧 Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: 🔧 Set up Test Environment
      run: |
        echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> .env
        echo "SUPABASE_SERVICE_KEY=${{ secrets.SUPABASE_SERVICE_KEY }}" >> .env
        echo "ENVIRONMENT=testing" >> .env
        echo "DEBUG=true" >> .env
        echo "LOG_LEVEL=INFO" >> .env

    - name: 🧪 Run All Tests (Integration + Performance + Slow)
      if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == ''
      run: |
        python run_tests.py comprehensive

    - name: 🔗 Run Integration Tests Only
      if: github.event.inputs.test_type == 'integration'
      run: |
        pytest -v -m "integration" --tb=long tests/

    - name: ⚡ Run Performance Tests Only
      if: github.event.inputs.test_type == 'performance'
      run: |
        pytest -v -m "performance" --tb=long tests/

    - name: 🐌 Run Slow Tests Only
      if: github.event.inputs.test_type == 'slow'
      run: |
        pytest -v -m "slow" --tb=long tests/

    - name: 🗄️ Run Database Tests Only
      if: github.event.inputs.test_type == 'database'
      run: |
        pytest -v -m "database" --tb=long tests/

    - name: 📊 Generate Comprehensive Report
      if: always()
      run: |
        echo "## 🧪 Comprehensive Test Results" >> $GITHUB_STEP_SUMMARY
        echo "- Test Type: ${{ github.event.inputs.test_type || 'all' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Trigger: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

    - name: 📁 Upload Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: comprehensive-test-results
        path: |
          htmlcov/
          .pytest_cache/
          *.log