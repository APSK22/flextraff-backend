name: ðŸš€ CI/CD Pipeline - FlexTraff Backend

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: "3.11"

jobs:
  fast-tests:
    name: âš¡ Fast Tests (Unit + Algorithm)
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ðŸ“¦ Cache Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: ðŸ”§ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: âš¡ Run Fast Tests Only
      run: |
        # Run only unit and algorithm tests (exclude slow, integration, performance, database)
        pytest -v \
          -m "unit or algorithm" \
          --tb=short \
          --maxfail=5 \
          --durations=10 \
          tests/

    - name: ðŸ“Š Generate Test Report
      if: always()
      run: |
        echo "## âš¡ Fast Test Results" >> $GITHUB_STEP_SUMMARY
        echo "- Unit Tests: âœ… Completed" >> $GITHUB_STEP_SUMMARY
        echo "- Algorithm Tests: âœ… Completed" >> $GITHUB_STEP_SUMMARY
        echo "- Integration Tests: â­ï¸ Skipped (CI optimization)" >> $GITHUB_STEP_SUMMARY
        echo "- Performance Tests: â­ï¸ Skipped (CI optimization)" >> $GITHUB_STEP_SUMMARY

  code-quality:
    name: ðŸ” Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ðŸ”§ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black isort flake8 mypy

    - name: ðŸŽ¨ Check Code Formatting (Black)
      run: |
        black --check --diff app/ tests/ main.py

    - name: ðŸ“¦ Check Import Sorting (isort)
      run: |
        isort --check-only --diff app/ tests/ main.py

    - name: ðŸ” Lint Code (flake8)
      run: |
        flake8 app/ tests/ main.py --max-line-length=88 --extend-ignore=E203,W503

    - name: ðŸ·ï¸ Type Check (mypy)
      run: |
        mypy app/ main.py --ignore-missing-imports
      continue-on-error: true  # Don't fail CI on type check issues

  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ðŸ”§ Install Security Tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety

    - name: ðŸ›¡ï¸ Run Bandit Security Scan
      run: |
        bandit -r app/ -f json || true

    - name: ðŸ” Check Dependencies for Vulnerabilities
      run: |
        safety check --json || true

  deploy-to-render:
    name: ðŸš€ Deploy to Render
    runs-on: ubuntu-latest
    needs: [fast-tests, code-quality]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸš€ Trigger Render Deployment
      run: |
        echo "ðŸš€ Deploying to Render..."
        # Render will automatically deploy from GitHub when we push to main
        # No additional action needed - just confirm the pipeline passed
        
    - name: â³ Wait for Deployment
      run: |
        echo "â³ Waiting for Render to complete deployment..."
        sleep 30

    - name: ðŸ¥ Health Check
      run: |
        echo "ðŸ¥ Performing health check..."
        # Replace with your actual Render URL
        for i in {1..10}; do
          if curl -f "${{ secrets.RENDER_APP_URL }}/health" 2>/dev/null; then
            echo "âœ… Health check passed!"
            break
          else
            echo "â³ Attempt $i failed, retrying in 10 seconds..."
            sleep 10
          fi
        done

    - name: ðŸ“ Deployment Summary
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Fast tests passed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Code quality checks passed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Security scan completed" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸš€ Deployed to Render successfully" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŒ App URL: ${{ secrets.RENDER_APP_URL }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“š API Docs: ${{ secrets.RENDER_APP_URL }}/docs" >> $GITHUB_STEP_SUMMARY

  notify-success:
    name: ðŸŽ‰ Success Notification
    runs-on: ubuntu-latest
    needs: [fast-tests, code-quality, security-scan, deploy-to-render]
    if: success() && github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸŽ‰ Success Message
      run: |
        echo "ðŸŽ‰ Pipeline completed successfully!"
        echo "âœ… All fast tests passed"
        echo "âœ… Code quality checks passed"
        echo "âœ… Security scan completed"
        echo "ðŸš€ Successfully deployed to Render"