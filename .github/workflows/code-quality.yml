name: 🔍 Code Quality (Manual)

on:
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Type of quality check to run'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - formatting
        - linting
        - type-check

jobs:
  code-quality:
    name: 🔍 Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout Code
      uses: actions/checkout@v4

    - name: 🐍 Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: 🔧 Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black isort flake8 mypy

    - name: 🎨 Check Code Formatting (Black)
      if: github.event.inputs.check_type == 'all' || github.event.inputs.check_type == 'formatting'
      run: |
        echo "🎨 Running Black formatter check..."
        black --check --diff app/ tests/ main.py || echo "❌ Formatting issues found"

    - name: 📦 Check Import Sorting (isort)
      if: github.event.inputs.check_type == 'all' || github.event.inputs.check_type == 'formatting'
      run: |
        echo "📦 Running isort import sorting check..."
        isort --check-only --diff app/ tests/ main.py || echo "❌ Import sorting issues found"

    - name: 🔍 Lint Code (flake8)
      if: github.event.inputs.check_type == 'all' || github.event.inputs.check_type == 'linting'
      run: |
        echo "🔍 Running flake8 linting..."
        flake8 app/ tests/ main.py --statistics || echo "❌ Linting issues found"

    - name: 🏷️ Type Check (mypy)
      if: github.event.inputs.check_type == 'all' || github.event.inputs.check_type == 'type-check'
      run: |
        echo "🏷️ Running mypy type checking..."
        mypy app/ main.py --ignore-missing-imports || echo "❌ Type checking issues found"

    - name: 🔧 Auto-fix Instructions
      if: always()
      run: |
        echo "## 🔧 To fix code quality issues locally:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Format code:" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "black ." >> $GITHUB_STEP_SUMMARY
        echo "isort ." >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Check linting:" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "flake8 app/ tests/ main.py --statistics" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY